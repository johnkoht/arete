---
description: When in Plan Mode or multi-step plans, conduct a pre-mortem before execution
globs: ["src/**/*", "test/**/*", "dev/**/*"]
---

# Plan Mode: Pre-Mortem Required

**Only when in Build Context (BUILDER mode).** See `arete-context.mdc`. Ignore in GUIDE mode or end-user workspaces.

## When This Applies

You **must** conduct a pre-mortem when **any** of these are true:

- The user started the agent in **Plan Mode** (Cursor’s plan-before-execute flow, e.g. Shift+Tab).
- You have created or are creating a **multi-step execution plan** (e.g. a markdown plan with 3+ steps, file paths, and code references).
- The work is **PRD execution**, a **large refactor**, a **new system**, or **integration work** across multiple components.

If the work is a single, well-understood task, a pre-mortem is optional.

## PRD Gateway: Large Plans

**Before** running a pre-mortem, check whether this plan is substantial enough to warrant the PRD path.

**Offer PRD path** if any of these apply:

- Plan has **3+ numbered or bullet steps**
- Plan mentions: new system, new integration, large refactor, multi-file change
- Plan references **multiple components** (e.g. `src/`, `test/`, `docs/`)

**If PRD path applies**, present this choice to the user:

> "This plan has [X] steps and involves [brief scope]. For work of this size, Areté recommends using the **PRD + autonomous agent loop** for better risk mitigation and execution quality. Would you like to:
>
> 1. **Convert to PRD** — I'll create prd.md and prd.json, then give you a handoff prompt for a new agent to execute via execute-prd.
> 2. **Proceed with plan** — I'll run a pre-mortem and execute this plan directly."

- **If user chooses "Convert to PRD"**: Load `dev/skills/plan-to-prd/SKILL.md` and follow its workflow. Do not execute the plan.
- **If user chooses "Proceed with plan"**: Continue with the pre-mortem below.

**If plan does not meet the threshold**: Skip the PRD offer and go directly to the pre-mortem.

## What to Do

**After** you have a draft plan and **before** you start executing it (and after the PRD gateway, if applicable):

1. **Run a pre-mortem** using the same process as the execute-prd skill:
   - Read `dev/templates/PRE-MORTEM-TEMPLATE.md` for the format and risk categories.
   - Consider the **8 risk categories**: Context Gaps, Test Patterns, Integration, Scope Creep, Code Quality, Dependencies, Platform Issues, State Tracking.
   - For each relevant risk: **Problem** (what could go wrong), **Mitigation** (concrete action), **Verification** (how to check it was applied).

2. **Present** the risks and mitigations to the user (e.g. a short table or list).

3. **Get approval** (e.g. “Proceed with these mitigations?”) unless the user has already asked you to run without confirmation.

4. **Then execute** the plan, applying the mitigations as you go (e.g. list files to read first, reference test patterns, run full test suite between steps).

## References

- **PRD gateway skill**: `dev/skills/plan-to-prd/SKILL.md`
- **Template and categories**: `dev/templates/PRE-MORTEM-TEMPLATE.md`
- **Rationale and examples**: `dev/PRE-MORTEM-AND-ORCHESTRATION-RECOMMENDATIONS.md`
- **Full workflow (PRD execution)**: `dev/skills/execute-prd/SKILL.md`

## Why This Matters

Pre-mortems turn vague “this could be tricky” into specific, actionable mitigations. In past PRD runs, every identified risk was prevented because mitigations were applied during execution. Plan Mode gets the same benefit when you run a pre-mortem before executing the plan.
