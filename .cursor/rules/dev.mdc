---
description: Dev practices for Arete — quality gates, checklists, procedural workflows
globs: ["src/**/*", "test/**/*", "scripts/**/*", "bin/**/*", ".cursor/**/*", ".agents/**/*", "runtime/**/*"]
alwaysApply: true
---

# Dev practices (Arete build)

Standards for building and changing Arete. For conventions, memory usage, skills index, and CLI reference, see **AGENTS.md** (the compressed, always-loaded context).

**Testing** is covered in `testing.mdc`; **Plan Mode pre-mortem** is in `plan-pre-mortem.mdc`.

---

## Quality Gates (mandatory for ALL commits)

Before any commit, these **must pass**:

```bash
npm run typecheck  # Must pass
npm test           # Must pass (full suite, not just new tests)
```

If the work touches Python (`scripts/integrations/`), also run:
```bash
npm run test:py
```

**No exceptions** — even for "quick fixes." Quality gates catch ripple effects.

---

## Execution Path Decision Tree

When you approve a plan (in Plan Mode or otherwise), follow this decision tree:

```
User approves plan
     |
     ├─ Tiny (1-2 simple steps: fix typo, add comment, update string)
     |  → Direct execution
     |  → Quality gates (typecheck + test) ✓
     |  → Skip pre-mortem, skip memory capture
     |
     ├─ Small (2-3 moderate steps: add function + tests, refactor module)
     |  → Ask: "Run pre-mortem first? (Recommended for new features)"
     |  → Direct execution (with optional pre-mortem)
     |  → Quality gates ✓
     |  → Offer: "Capture learnings?" at end
     |
     └─ Medium/Large (3+ steps OR complex: new system, integration, refactor)
        → Strongly recommend: "PRD path or direct execution?"
        → If PRD: Load .agents/skills/plan-to-prd/SKILL.md (full execute-prd workflow)
        → If direct: Apply pre-mortem + quality gates + memory capture
```

**Examples:**

| User Request | Size | Path | Why |
|-------------|------|------|-----|
| "Fix typo in README" | Tiny | Direct, no pre-mortem | Single file, trivial change |
| "Add validation to email field" | Small | Ask about pre-mortem | 2-3 files, clear scope |
| "Add retry logic with exponential backoff" | Small→Medium | Pre-mortem recommended | 2-3 files but touches error handling |
| "Add calendar integration" | Large | Recommend PRD | New system, 5+ tasks, integration risk |

**When in doubt**: Offer both paths and let builder choose.

---

## Code Review Checklist (for any substantial change)

Apply this 6-point checklist before committing:

- [ ] **Uses `.js` extensions** in imports (NodeNext module resolution)
- [ ] **No `any` types** (strict TypeScript)
- [ ] **Proper error handling** (try/catch with graceful fallback)
- [ ] **Tests for happy path and edge cases**
- [ ] **Backward compatibility preserved** (function signatures unchanged unless explicitly breaking)
- [ ] **Follows project patterns** (see existing code, AGENTS.md conventions)

If any item fails, fix before committing.

---

## Skill and Rule Changes (mandatory review)

**When**: Before creating or modifying any skill or rule file.

**Checklist**:
- [ ] **Audience check**: Is this for BUILD (dev/, .cursor/, .agents/) or PRODUCT (runtime/)?
- [ ] **AGENTS.md sources**: If the skill/rule changes workflows, update `.agents/sources/` and rebuild
- [ ] **Cross-references**: Search for references to the skill/rule being changed; update them

**AGENTS.md is generated** — do not edit it directly. Update source files in `.agents/sources/` and rebuild:

```bash
npm run build:agents:dev  # Rebuild BUILD AGENTS.md
npm run build             # Rebuild GUIDE AGENTS.md (included in package build)
```

See `.agents/sources/README.md` for detailed editing workflow.

---

## Multi-IDE Consistency Check

**When**: Before editing files in `runtime/rules/`, `runtime/tools/`, or `.agents/sources/guide/`.

**Checklist**:
- [ ] **No "either/or" paths**: Don't write `.cursor/X or .claude/X` — use only `.cursor/X` (adapter transforms it)
- [ ] **No hardcoded IDE names in content**: Use `.cursor/` paths; the adapter handles `.claude/` conversion

**Pre-commit check**:
```bash
rg "\.cursor.*or.*\.claude|\.claude.*or.*\.cursor" .agents/sources/ runtime/
```

---

## Documentation Planning Checklist

When creating plans that touch code/features/structure, ask: **"Does this need doc updates?"**

**Scope Check:**
- [ ] All root docs: README, SETUP, AGENTS sources, scratchpad
- [ ] Backlog items: `grep -l "update.*\.md\|docs" dev/backlog/*/*.md`

**Search Strategy:**
- [ ] Feature keywords: `rg "keyword1|keyword2" -g "*.md"`
- [ ] Concept audit: If feature changes paths/structure, grep old paths in all `.md` files

**Anti-pattern:** Do not assume "documentation" = README + SETUP. scratchpad and backlog frequently need updates.

---

## Before Committing

1. `npm run typecheck`
2. `npm run test:all` (or `npm test` + `npm run test:py`)
3. New code → new/updated tests (see `testing.mdc`)

---

## References

- **AGENTS.md**: Conventions, skills index, memory guidance, CLI reference (compressed, always-loaded)
- **Testing**: `.cursor/rules/testing.mdc`
- **Plan Mode**: `.cursor/rules/plan-pre-mortem.mdc`
- **Build memory**: `memory/MEMORY.md`, `memory/collaboration.md`
- **Pi workflow**: `.pi/` — Pi coding agent configuration for terminal-native development (alternative to Cursor)
