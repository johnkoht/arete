---
description: Testing requirements - all code changes must include tests
globs: ["src/**/*", "scripts/**/*", "bin/**/*", "test/**/*"]
---

# Testing Requirements

**Only when in Build Context (BUILDER mode).** See `arete-context.mdc`. If `agent_mode` is `guide` or you are in an end-user workspace, ignore this rule.

All code changes in this workspace MUST include corresponding tests. Never ship code without test coverage.

## Test Infrastructure

### TypeScript (Node.js built-in test runner via tsx)

- **Location**: `test/` directory, mirroring `src/` structure
- **Naming**: `*.test.ts` (e.g., `test/core/config.test.ts`)
- **Runner**: `tsx --test 'test/**/*.test.ts'` or `npm test`
- **Imports**: Use `node:test` (`describe`, `it`, `beforeEach`, `afterEach`, `mock`) and `node:assert/strict`
- **Pattern**: ES modules with TypeScript types
- **Import paths**: Use `.js` extensions in imports (required by NodeNext module resolution)

```typescript
import { describe, it, beforeEach, afterEach } from 'node:test';
import assert from 'node:assert/strict';
import { someFunction } from '../../src/core/module.js';
```

### Python (unittest)

- **Location**: `scripts/integrations/test_*.py` (co-located with source)
- **Naming**: `test_<module>.py` (e.g., `test_utils.py`)
- **Runner**: `python3 -m unittest scripts/integrations/test_*.py` or `npm run test:py`
- **Pattern**: `unittest.TestCase` with `unittest.mock` for mocking

```python
import unittest
from unittest.mock import patch, MagicMock
```

## Rules

### 1. Every Code Change Needs Tests

- **New functions/modules**: Write unit tests covering happy path, edge cases, and error handling
- **Bug fixes**: Write a regression test that reproduces the bug before fixing it
- **Refactors**: Ensure existing tests still pass; add tests for any new behavior

### 2. Test Structure

- **Descriptive names**: Test names should describe the behavior being tested
- **Arrange-Act-Assert**: Follow the AAA pattern in each test
- **Isolation**: Tests must not depend on external services, network, or filesystem state
- **Mocking**: Mock external dependencies (APIs, filesystem, child processes)
- **Cleanup**: Use `beforeEach`/`afterEach` (TS) or `setUp`/`tearDown` (Python) to clean up temp files

### 3. What to Test

| Layer | Test Focus | Mocking |
|-------|-----------|---------|
| Core utilities (`src/core/`) | Pure logic, config resolution, path handling | Mock filesystem |
| Commands (`src/commands/`) | Command routing, error handling, output format | Mock workspace, child_process |
| Types (`src/types.ts`) | Type definitions don't need tests | N/A |
| Python integrations (`scripts/`) | API client logic, data transformation, filtering | Mock HTTP requests |

### 4. Running Tests

```bash
# All tests (typecheck + JS + Python)
npm run test:all

# TypeScript tests only
npm test

# Python tests only
npm run test:py

# Type checking only
npm run typecheck
```

### 5. Before Submitting Changes

- Run `npm run typecheck` to verify types are correct
- Run `npm test` to verify TS tests pass
- Run `npm run test:py` to verify Python tests pass
- Ensure no test regressions

## Test File Mapping

| Source File | Test File |
|------------|-----------|
| `src/core/config.ts` | `test/core/config.test.ts` |
| `src/core/workspace.ts` | `test/core/workspace.test.ts` |
| `src/core/utils.ts` | `test/core/utils.test.ts` |
| `src/integrations/fathom/` | `test/integrations/fathom.test.ts` |
| `scripts/integrations/utils.py` | `scripts/integrations/test_utils.py` |

When adding new source files, create a corresponding test file following this pattern.

### 6. Seed test-data: do not run in arete repo

When working on testing, seed, or `test-data/` functionality:

- **Do not run** `arete seed test-data` when the workspace is the arete development repo (contains `test-data/`, `src/commands/seed-test-data.ts`).
- **Remind the user** to run seed only in a separate Aret√©-enabled project, not in the arete repo.
- **After completing a task**, check for accidentally generated seed data: `people/internal/jane-doe.md`, `alex-eng.md`, `people/customers/bob-buyer.md`, `carol-champion.md`, `resources/meetings/2026-*.md`, `projects/active/onboarding-discovery/`, `TEST-SCENARIOS.md` at root. If found, ask: "Seed test data appears to have been generated in this workspace. Should I remove it?"
