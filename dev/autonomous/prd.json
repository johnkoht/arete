{
  "name": "planning-system-refinement",
  "branchName": "feature/planning-system-refinement",
  "goal": "Refine the plan-mode extension to implement linear pipeline flow, auto-save artifacts, wire agent prompts, route menu selections through commands, and correct pipeline order.",
  "userStories": [
    {
      "id": "task-1",
      "title": "Add phase tracking to state",
      "description": "Add currentPhase and activeCommand fields to PlanModeState to track where user is in the linear flow and which command is running.",
      "acceptanceCriteria": [
        "Add currentPhase: Phase where Phase = 'plan' | 'prd' | 'pre-mortem' | 'review' | 'build' | 'done'",
        "Add activeCommand: string | null to track which command is running",
        "Phase initializes to 'plan' on /plan or /plan new",
        "Phase persists across sessions via appendEntry()",
        "createDefaultState() sets both fields",
        "Note: Phase controls menus; completion flags (preMortemRun etc.) track what's done â€” keep them separate"
      ],
      "status": "complete",
      "passes": true,
      "attemptCount": 1,
      "commitSha": "f312916"
    },
    {
      "id": "task-2",
      "title": "Create phase-based menu helper",
      "description": "Replace getMenuOptions() with getPhaseMenu() returning exactly two options (refine/next) based on current phase.",
      "acceptanceCriteria": [
        "Add Phase type export",
        "Add getPhaseMenu(phase, planSize): { refine: string, next: string | null }",
        "Plan phase: 'Refine plan' / 'Continue to PRD' (medium/large) or 'Continue to pre-mortem' (tiny/small)",
        "PRD phase: 'Refine PRD' / 'Continue to pre-mortem'",
        "Pre-mortem phase: 'Refine pre-mortem' / 'Continue to review' or 'Skip review â†’ build'",
        "Review phase: 'Refine review' / 'Continue to build'",
        "Build/done: return nulls (no menu)",
        "Keep getMenuOptions() but mark @deprecated",
        "Tests pass"
      ],
      "status": "complete",
      "passes": true,
      "attemptCount": 1,
      "commitSha": "PENDING",
      "dependencies": ["task-1"]
    },
    {
      "id": "task-3",
      "title": "Implement auto-save for artifacts",
      "description": "Extract content from agent response and save to artifact files instead of placeholders.",
      "acceptanceCriteria": [
        "Add extractPhaseContent(response: string, phase: Phase): string",
        "Extraction looks for headers: 'Plan:', '## Pre-Mortem', '## Review', '### Risk'",
        "If no headers found, return full response (fallback)",
        "Never save empty string â€” log warning and skip",
        "After plan phase: update plan.md content section",
        "After pre-mortem: save to pre-mortem.md with actual content",
        "After review: save to review.md with actual content",
        "Add extraction comment: <!-- Extracted at {timestamp} -->",
        "Remove placeholder-saving code from handlePreMortem and handleReview"
      ],
      "status": "complete",
      "passes": true,
      "attemptCount": 1,
      "commitSha": "PENDING"
    },
    {
      "id": "task-4",
      "title": "Route menu selections through commands",
      "description": "Make 'Continue to X' invoke actual commands. Commands are phase-independent but set completion flags.",
      "acceptanceCriteria": [
        "'Continue to pre-mortem' calls handlePreMortem() + advances phase",
        "'Continue to review' calls handleReview() + advances phase",
        "'Continue to build' calls handleBuild()",
        "/pre-mortem and /review can be called from ANY phase (don't check currentPhase)",
        "These commands set completion flags but DON'T change currentPhase",
        "Remove direct plan-mode-execute bypass path",
        "Phase advances only via menu 'Continue to X' selection"
      ],
      "status": "complete",
      "passes": true,
      "attemptCount": 1,
      "commitSha": "PENDING",
      "dependencies": ["task-2", "task-3"]
    },
    {
      "id": "task-5",
      "title": "Wire agent prompts into commands",
      "description": "Inject appropriate agent prompt based on activeCommand, not currentPhase.",
      "acceptanceCriteria": [
        "Set state.activeCommand when command starts, clear when done",
        "In before_agent_start, inject prompt based on activeCommand: 'pre-mortem' â†’ orchestrator.md, 'review' â†’ reviewer.md, 'build' â†’ orchestrator.md, null (plan mode) â†’ product-manager.md",
        "Injection order: base context â†’ agent prompt â†’ plan content",
        "Only one agent prompt injected per turn",
        "getAgentPrompt() is called (not hardcoded strings)"
      ],
      "status": "complete",
      "passes": true,
      "attemptCount": 1,
      "commitSha": "PENDING",
      "dependencies": ["task-1"]
    },
    {
      "id": "task-6",
      "title": "Update pipeline order in lifecycle.ts",
      "description": "Change gate order to: prd â†’ pre-mortem â†’ review (not review â†’ pre-mortem â†’ prd).",
      "acceptanceCriteria": [
        "getMissingGates() returns gates in order: prd, pre-mortem, review",
        "getGateRequirements() returns in same order",
        "/plan next shows gates in this order",
        "Update lifecycle tests to assert new order",
        "Grep and fix any order-dependent test assertions"
      ],
      "status": "complete",
      "passes": true,
      "attemptCount": 1,
      "commitSha": "PENDING"
    },
    {
      "id": "task-7",
      "title": "Update widget pipeline stages",
      "description": "Add PRD stage to widget and show completion checkmarks based on phase.",
      "acceptanceCriteria": [
        "Add { emoji: 'ðŸ“„', label: 'PRD', key: 'prd' } to PIPELINE_STAGES after Plan",
        "Widget shows 6 stages: Plan â†’ PRD â†’ Pre-mortem â†’ Review â†’ Build â†’ Done",
        "getCurrentStage() uses currentPhase as primary source",
        "getCompletedStages() marks stages based on phase progression",
        "Footer shows completion: 'ðŸ“‹ plan (pre-mortem âœ“, review âœ“)' when applicable",
        "Widget tests pass for each phase value"
      ],
      "status": "complete",
      "passes": true,
      "attemptCount": 1,
      "commitSha": "PENDING",
      "dependencies": ["task-1", "task-6"]
    },
    {
      "id": "task-8",
      "title": "Handle Refine option and /build gating",
      "description": "Implement refine loop and build gate logic with pre-mortem/review checks.",
      "acceptanceCriteria": [
        "'Refine X' opens editor for feedback",
        "User input sent via sendUserMessage() with phase context",
        "Track isRefining: boolean to prevent menu loop",
        "After agent response: clear isRefining, auto-save, show menu",
        "/build gating: if !preMortemRun && planSize !== 'tiny': confirm('Pre-mortem not completed. Skip?')",
        "/build gating: if !reviewRun: notify('Review not completed. Proceeding.')",
        "Proceed to build after acknowledgment",
        "Can refine multiple times before continuing"
      ],
      "status": "complete",
      "passes": true,
      "attemptCount": 1,
      "commitSha": "PENDING",
      "dependencies": ["task-4", "task-7"]
    }
  ],
  "metadata": {
    "createdAt": "2026-02-18T04:10:00.000Z",
    "totalTasks": 8,
    "completedTasks": 8,
    "failedTasks": 0
  }
}
