{
  "name": "template-architecture",
  "branchName": "feature/template-architecture",
  "goal": "Ship default templates and GUIDE.md to user workspaces on install; backfill missing files on update; co-locate create-prd templates with the skill; implement 3-level template resolution order.",
  "userStories": [
    {
      "id": "task-1-source-paths-and-install",
      "title": "Extend SourcePaths + fix template and GUIDE.md copy in install",
      "description": "Add `guide: string` field to SourcePaths type pointing to GUIDE.md file path. Update getSourcePaths() to set guide field. Add template copy loop to WorkspaceService.create() (source: sourcePaths.templates, dest: {targetDir}/templates/, skip-if-exists, recursive). Add GUIDE.md copy to WorkspaceService.create() (source: sourcePaths.guide, dest: {targetDir}/GUIDE.md, skip-if-exists). Update install.ts and update.ts CLI commands to pass guide through sourcePaths.",
      "acceptanceCriteria": [
        "SourcePaths type has `guide: string` field",
        "getSourcePaths() sets guide to join(base, 'GUIDE.md')",
        "WorkspaceService.create() copies all files from sourcePaths.templates into {targetDir}/templates/ recursively",
        "WorkspaceService.create() copies GUIDE.md to {targetDir}/GUIDE.md",
        "Existing files at destination are never overwritten (skip-if-exists)",
        "result.files includes template paths and GUIDE.md path on success",
        "No crash if sourcePaths.guide is missing or GUIDE.md doesn't exist at source",
        "npm run typecheck passes",
        "npm test passes"
      ],
      "status": "pending",
      "passes": false,
      "attemptCount": 0
    },
    {
      "id": "task-2-update-backfill",
      "title": "Add GUIDE.md and template backfill to arete update",
      "description": "Add GUIDE.md backfill to WorkspaceService.update(): if {workspaceRoot}/GUIDE.md is missing and options.sourcePaths.guide exists, copy it; if it exists, skip. Add template backfill loop to WorkspaceService.update(): iterate source templates recursively; for each file, if destination does not exist copy it; if it exists skip it. Add backfilled paths to result.added. Policy: 'only write if file does not exist' — no content comparison, no checksums.",
      "acceptanceCriteria": [
        "arete update on workspace missing GUIDE.md creates GUIDE.md at workspace root",
        "arete update on workspace with existing GUIDE.md leaves it untouched",
        "arete update on workspace missing template file creates that template file",
        "arete update on workspace with existing template file leaves it untouched",
        "result.added reflects what was backfilled",
        "No crash when sourcePaths.templates or sourcePaths.guide is undefined",
        "npm run typecheck passes",
        "npm test passes"
      ],
      "status": "pending",
      "passes": false,
      "attemptCount": 0
    },
    {
      "id": "task-3-skill-local-templates",
      "title": "Add skill-local templates for create-prd",
      "description": "Create packages/runtime/skills/create-prd/templates/ directory. Copy prd-simple.md, prd-regular.md, prd-full.md from packages/runtime/templates/outputs/ into packages/runtime/skills/create-prd/templates/. Do NOT delete the originals in templates/outputs/ — they serve as legacy fallback for existing workspaces.",
      "acceptanceCriteria": [
        "packages/runtime/skills/create-prd/templates/prd-simple.md exists",
        "packages/runtime/skills/create-prd/templates/prd-regular.md exists",
        "packages/runtime/skills/create-prd/templates/prd-full.md exists",
        "packages/runtime/templates/outputs/prd-simple.md still exists (not deleted)",
        "packages/runtime/templates/outputs/prd-regular.md still exists (not deleted)",
        "packages/runtime/templates/outputs/prd-full.md still exists (not deleted)",
        "Content of skill-local copies matches originals",
        "npm run typecheck passes",
        "npm test passes"
      ],
      "status": "pending",
      "passes": false,
      "attemptCount": 0
    },
    {
      "id": "task-4-resolve-template-path",
      "title": "Implement resolveTemplatePath() utility",
      "description": "Add resolveTemplatePath(workspaceRoot, skillId, variant) async function to packages/core/src/utils/templates.ts. Implements 3-level resolution using fs/promises.access(): (1) workspace override: {workspaceRoot}/templates/outputs/{skillId}/{variant}.md, (2) skill-local: {workspaceRoot}/.agents/skills/{skillId}/templates/{variant}.md, (3) legacy fallback: {workspaceRoot}/templates/outputs/{variant}.md. Returns the first path that exists as a string, or null if none found. Export from packages/core/src/utils/index.ts.",
      "acceptanceCriteria": [
        "resolveTemplatePath returns workspace override path when it exists",
        "resolveTemplatePath returns skill-local path when override doesn't exist but skill-local does",
        "resolveTemplatePath returns legacy fallback path when neither override nor skill-local exists",
        "resolveTemplatePath returns null when no template found at any level",
        "resolveTemplatePath prefers override over skill-local when both exist",
        "resolveTemplatePath prefers skill-local over legacy when both exist",
        "Function uses fs/promises.access() not readFile for existence checks",
        "No any types; async with proper error handling",
        "Exported from packages/core/src/utils/index.ts",
        "npm run typecheck passes",
        "npm test passes"
      ],
      "status": "pending",
      "passes": false,
      "attemptCount": 0
    },
    {
      "id": "task-5-skill-md-update",
      "title": "Update create-prd SKILL.md with template resolution instructions",
      "description": "Update the Template Selection section (Step 4) of packages/runtime/skills/create-prd/SKILL.md to document 3-level template resolution order in plain language for agents. Replace hardcoded template paths with explicit resolution instructions referencing all three levels. No other content in SKILL.md should change.",
      "acceptanceCriteria": [
        "Template Selection section documents all three resolution levels in priority order",
        "Level 1 workspace override path is documented: templates/outputs/create-prd/{variant}.md",
        "Level 2 skill-local path is documented: .agents/skills/create-prd/templates/{variant}.md",
        "Level 3 legacy fallback path is documented: templates/outputs/{variant}.md",
        "Instructions are written in plain language suitable for AI agents",
        "Variant values (prd-simple, prd-regular, prd-full) are still documented",
        "No other SKILL.md content is changed",
        "npm run typecheck passes",
        "npm test passes"
      ],
      "status": "pending",
      "passes": false,
      "attemptCount": 0
    },
    {
      "id": "task-6-tests",
      "title": "Unit and integration tests",
      "description": "Add unit tests for resolveTemplatePath() in packages/core/test/utils/templates.test.ts (new file). Add integration tests to packages/cli/test/integration/install-update.integration.test.ts covering install outputs and update backfill behavior. Unit tests use real temp directories (not mocked fs). Integration tests use existing createIntegrationSandbox() and installWorkspace() helpers.",
      "acceptanceCriteria": [
        "packages/core/test/utils/templates.test.ts exists and passes",
        "Unit tests cover: override wins over skill-local, skill-local wins over legacy, legacy used when only that exists, null returned when nothing exists, override wins when all three exist, skill-local wins when skill-local + legacy exist",
        "Integration tests added to install-update.integration.test.ts",
        "Integration test: arete install produces workspace with GUIDE.md at root",
        "Integration test: arete install produces workspace with templates/outputs/prd-simple.md",
        "Integration test: arete install produces workspace with templates/outputs/prd-regular.md",
        "Integration test: arete install produces workspace with templates/outputs/prd-full.md",
        "Integration test: arete update backfills missing GUIDE.md without touching existing GUIDE.md",
        "Integration test: arete update backfills missing template without touching existing template",
        "All tests use node:test and node:assert/strict",
        "All imports use .js extensions",
        "npm run typecheck passes",
        "npm test passes (full suite)"
      ],
      "status": "pending",
      "passes": false,
      "attemptCount": 0
    }
  ],
  "metadata": {
    "createdAt": "2026-02-17T12:30:00Z",
    "totalTasks": 6,
    "completedTasks": 0,
    "failedTasks": 0
  }
}
